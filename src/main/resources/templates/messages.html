<!DOCTYPE html>
<!-- License: https://codyhouse.co/mit -->
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<link rel="stylesheet" th:href="@{/css/schedule-style.css}"
	href="../css/schedule-style.css">
<th:block th:replace="fragments/head :: header" />
<title>Horario</title>
</head>

<body>
	<!--[if IE]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->

	<!-- Add your site or application content here -->

	<div th:replace="fragments/nav.html :: nav">Nav goes here</div>

	<header class="cd-main-header text-center flex flex-column flex-center">
		<h4 class="center-align">Últimos mensajes</h4>
	</header>

	<div class="row">
	<div class="center-align col s10 offset-s1">
		<br> <a
			class="btn waves-effect waves-light btn-large center-align sidenav-trigger"
			data-target="slide-out"> Usuarios / Topics <i
			class="material-icons right">chat</i>
		</a>
	</div>
	</div>
	<br>

	<!-- 	<div class="nav-wrapper">
		<form th:action="@{/admin/findUsers}" method="post"
			name="findUserForm">
			<div class="row">

				<div class="input-field col s8 m8 offset-s1 offset-m1">
					<input id="search" type="search" name="search" required> <label
						class="label-icon" for="search"><i class="material-icons">search</i></label>
					<i class="material-icons">close</i>
				</div>

				<button class="col s2 m2 btn waves-effect waves-light btn-large"
					type="submit">
					Filtrar <i class="material-icons right">send</i>
				</button>
			</div>
			<div class="row">
				<span class="col offset-s1">Filtro: </span> <label> <input
					name="filter" type="radio" value="nickname" checked /> <span>Usuario</span>
				</label> <label> <input name="filter" value="email" type="radio" />
					<span>Topic</span>
				</label>

			</div>
		</form>
	</div> -->

	<div class="row" id="mensajes"></div>

	<form id="form-send" class="float row hide" method="POST">
		<input type="text" id="message" class="col s9 offset-s1">
		<button id="send" th:data-id-sender="${session.u.id}" th:data-username-sender="${session.u.username}" data-id-receiver="" data-topic="" class="boton-enviar btn-floating waves-effect waves-light"
			type="submit" name="action">
			<i class="material-icons right" id="sendmsg">send</i>
		</button>
	</form>




	<ul id="slide-out" class="sidenav">
    <li><div class="user-view">
      <div class="background">
        <img src="../img/background1.jpg">
      </div>
      <a href="#user"><img class="circle" th:src="@{${'/user/' + session.u.id + '/photo?=' + session.u.id}}"></a>
      <a href="#name"><span class="white-text name" th:text="${session.u.firstName}">Ejempl</span></a>
      <a href="#email"><span class="white-text email" th:text="${session.u.username}">jdandturk@gmail.com</span></a>
    </div></li>
    <li><a class="subheader">Citas grupales</a></li>
    <li th:if="${session.u.hasRole('ADMIN')}"><a class="waves-effect" th:data-id="admin" th:text="admin" th:onclick="getMessagesTopic(admin);">Usuario 1</a></li>
    <li th:if="${session.topics != ''}" th:each="g : ${session.topics}"><a class="waves-effect" th:data-id="${g}" th:text="${g}" th:onclick="getMessagesTopic([[${g}]]);">Usuario 1</a></li>
    <li><a class="subheader">Usuarios</a></li>
    <li th:each="us : ${usuarios}"><a class="waves-effect sender" th:data-id="${us.id}" th:data-username="${us.username}" th:text="${us.username}" th:onclick="getMessages([[${us.id}]] , [[${us.username}]]);">Usuario 1</a></li>
  </ul>

	<script>
	
		var sender;
		
		function formatDate(d) {
			// 2020-03-23T10:48:11.074 => 23/3/2020@10:48:18
			return new Date(d).toLocaleString("es-ES").split(" ").join("@")
		}

		$.ajax({
					url : config.rootUrl + "message/received",
					type : 'GET',
					dataType : 'json',
					success : function(json) {
						for (var i = 0; i < json.length; ++i) {
							$('#mensajes')
									.append(
											'<div class="col s10 offset-s1 card horizontal"><div class="card-stacked"><div class="card-content"><p><b>'
													+ json[i].from
													+ '</b></p><p>'
													+ formatDate(json[i].sent)
													+ '</p><br><p>'
													+ json[i].text
													+ '</p></div></div></div>');
						}
					},
					error : function(xhr, status) {
						alert('Disculpe, existió un problema');
					},
				});
		
		function getMessages(id, username) {
			
			
			sender = username;
			console.log(sender);
			$('#mensajes').empty();
			$('#form-send').removeClass('hide');
			
			$('#send').attr("data-id-receiver", id);
			$('#send').attr("data-topic", '');
			
			$.ajax({
				url : config.rootUrl + "message/get/" + id,
				type : 'GET',
				dataType : 'json',
				success : function(json) {
					mensajes = json;
					for (var i = 0; i < json.length; ++i) {
						$('#mensajes')
								.append(
										'<div class="col s10 offset-s1 card horizontal"><div class="card-stacked"><div class="card-content"><p><b>'
												+ json[i].from
												+ '</b></p><p>'
												+ formatDate(json[i].sent)
												+ '</p><br><p>'
												+ json[i].text
												+ '</p></div></div></div>');
					}
				},
				error : function(xhr, status) {
					alert('Disculpe, existió un problema');
				}
			});
			
			

		
		}
		
		function getMessagesTopic(name) {
			
			sender = name;
			$('#mensajes').empty();
			$('#form-send').removeClass('hide');
			$('#send').attr("data-topic", name);
			$('#send').attr("data-id-receiver", '');
			//TODO borrar el receiver y viceversa
			
			$.ajax({
				url : config.rootUrl + "message/get-topic/" + name,
				type : 'GET',
				dataType : 'json',
				success : function(json) {
					mensajes = json;
					for (var i = 0; i < json.length; ++i) {
						$('#mensajes')
								.append(
										'<div class="col s10 offset-s1 card horizontal"><div class="card-stacked"><div class="card-content"><p><b>'
												+ json[i].from
												+ '</b></p><p>'
												+ formatDate(json[i].sent)
												+ '</p><br><p>'
												+ json[i].text
												+ '</p></div></div></div>');
					}
				},
				error : function(xhr, status) {
					alert('Disculpe, existió un problema');
				}
			});
			
			
			
		}
		
		document.addEventListener("DOMContentLoaded", () => {
			let b = document.getElementById("sendmsg");
			b.onclick = (e) => {
				var today = new Date();
				var action;
				if($("#send").attr("data-id-receiver")) action = "/user/" + $("#send").attr("data-id-receiver") + "/msg?=" + $("#send").attr("data-id-sender");
				else action = "/user/" + $("#send").attr("data-topic") + "/group-msg?=" + $("#send").attr("data-id-sender");
				e.preventDefault();
				go(action, 'POST', {message: 
						document.getElementById("message").value})
					.then(d => console.log("happy", d))
					.catch(e => console.log("sad", e))
				if($("#send").attr("data-id-receiver") != $("#send").attr("data-id-sender")) {
				$('#mensajes')
				.append(
						'<div class="col s10 offset-s1 card horizontal"><div class="card-stacked"><div class="card-content"><p><b>'
								+ $("#send").attr("data-username-sender")
								+ '</b></p><p>'
								+ today.toLocaleString("es-ES").split(" ").join("@")
								+ '</p><br><p>'
								+ document.getElementById("message").value
								+ '</p></div></div></div>');
				}
			}
		});
		
		
	</script>

	<footer th:replace="fragments/footer.html :: footer"> Footer
		goes here </footer>

</body>
</html>