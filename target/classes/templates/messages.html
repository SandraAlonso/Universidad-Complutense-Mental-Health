<!DOCTYPE html>
<!-- License: https://codyhouse.co/mit -->
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<link rel="stylesheet" th:href="@{/css/schedule-style.css}"
	href="../css/schedule-style.css">
<th:block th:replace="fragments/head :: header" />
<title>Horario</title>
</head>

<body>
	<!--[if IE]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->

	<!-- Add your site or application content here -->

	<div th:replace="fragments/nav.html :: nav">Nav goes here</div>

	<header class="cd-main-header text-center flex flex-column flex-center">
		<h4 class="center-align">Últimos mensajes</h4>
	</header>

	<div class="center-align">
		<br> <a
			class="col s2 m2 btn waves-effect waves-light btn-large center-align sidenav-trigger"
			data-target="slide-out"> Buscar usuarios/citas grupales <i
			class="material-icons right">chat</i>
		</a>
	</div>
	<br>

	<!-- 	<div class="nav-wrapper">
		<form th:action="@{/admin/findUsers}" method="post"
			name="findUserForm">
			<div class="row">

				<div class="input-field col s8 m8 offset-s1 offset-m1">
					<input id="search" type="search" name="search" required> <label
						class="label-icon" for="search"><i class="material-icons">search</i></label>
					<i class="material-icons">close</i>
				</div>

				<button class="col s2 m2 btn waves-effect waves-light btn-large"
					type="submit">
					Filtrar <i class="material-icons right">send</i>
				</button>
			</div>
			<div class="row">
				<span class="col offset-s1">Filtro: </span> <label> <input
					name="filter" type="radio" value="nickname" checked /> <span>Usuario</span>
				</label> <label> <input name="filter" value="email" type="radio" />
					<span>Topic</span>
				</label>

			</div>
		</form>
	</div> -->

	<div class="row" id="mensajes"></div>

	<form class="float row" th:action="@{/user/{id}/msg(id=${user.id})}" method="POST">
		<input type="text" id="message" class="col s9 offset-s1">
		<button class="boton-enviar btn-floating waves-effect waves-light"
			type="submit" name="action">
			<i class="material-icons right" id="sendmsg">send</i>
		</button>
	</form>




	<ul id="slide-out" class="sidenav">
    <li><div class="user-view">
      <div class="background">
        <img src="../img/background1.jpg">
      </div>
      <a href="#user"><img class="circle" th:src="@{${'/user/' + session.u.id + '/photo?=' + session.u.id}}"></a>
      <a href="#name"><span class="white-text name" th:text="${session.u.firstName}">Ejempl</span></a>
      <a href="#email"><span class="white-text email" th:text="${session.u.username}">jdandturk@gmail.com</span></a>
    </div></li>
    <li><a class="subheader">Citas grupales</a></li>
    <li th:each="g : ${group_appointments}"><a class="waves-effect" th:data-id="${g.name}" href="#!" th:text="${g.name}">Usuario 1</a></li>
    <li><a class="subheader">Usuarios</a></li>
    <li th:each="u : ${usuarios}"><a class="waves-effect" th:data-id="${u.id}" href="#!" th:text="${u.username}" th:onclick="'getMessages(\'' + ${u.id} + '\');'">Usuario 1</a></li>
  </ul>

	<script>
		
		function formatDate(d) {
			// 2020-03-23T10:48:11.074 => 23/3/2020@10:48:18
			return new Date(d).toLocaleString("es-ES").split(" ").join("@")
		}

		$.ajax({
					url : config.rootUrl + "message/received",
					type : 'GET',
					dataType : 'json',
					success : function(json) {
						mensajes = json;
						for (var i = 0; json.length; ++i) {
							$('#mensajes')
									.append(
											'<div class="col s10 offset-s1 card horizontal"><div class="card-stacked"><div class="card-content"><p><b>'
													+ json[i].from
													+ '</b></p><p>'
													+ formatDate(json[i].sent)
													+ '</p><br><p>'
													+ json[i].text
													+ '</p></div></div></div>');
						}
					},
					error : function(xhr, status) {
						alert('Disculpe, existió un problema');
					},
					complete : function(xhr, status) {
						alert('Petición realizada');
					}
				});
		
		function getMessages(id) {
			
			$('#mensajes').empty();
			
			$.ajax({
				url : config.rootUrl + "message/get/" + id,
				type : 'GET',
				dataType : 'json',
				success : function(json) {
					mensajes = json;
					for (var i = 0; json.length; ++i) {
						console.log(json);

						$('#mensajes')
								.append(
										'<div class="col s10 offset-s1 card horizontal"><div class="card-stacked"><div class="card-content"><p><b>'
												+ json[i].from
												+ '</b></p><p>'
												+ formatDate(json[i].sent)
												+ '</p><br><p>'
												+ json[i].text
												+ '</p></div></div></div>');
					}
				},
				error : function(xhr, status) {
					alert('Disculpe, existió un problema');
				},
				complete : function(xhr, status) {
					alert('Petición realizada');
				}
			});
			
			

		
		}
		
		document.addEventListener("DOMContentLoaded", () => {
			let b = document.getElementById("sendmsg");
			b.onclick = (e) => {
				e.preventDefault();
				console.log(b, b.parentNode)
				go(b.parentNode.action, 'POST', {message: 
						document.getElementById("message").value})
					.then(d => console.log("happy", d))
					.catch(e => console.log("sad", e))
				$('#mensajes')
				.append(
						'<div class="col s10 offset-s1 card horizontal"><div class="card-stacked"><div class="card-content"><p><b>'
								+ json[i].from
								+ '</b></p><p>'
								+ formatDate(json[i].sent)
								+ '</p><br><p>'
								+ document.getElementById("message").value
								+ '</p></div></div></div>');
				
			}
		});
	</script>

	<footer th:replace="fragments/footer.html :: footer"> Footer
		goes here </footer>

</body>
</html>